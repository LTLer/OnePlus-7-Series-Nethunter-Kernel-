name: Build Nethunter Kernel V4

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_kernel:
    runs-on: ubuntu-22.04
    env:
      KERNEL_DIR: ${{ github.workspace }}
      CLANG_VERSION: "16"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Update & install dependencies
        run: |
          sudo apt update -y
          sudo apt upgrade -y
          sudo apt install -y \
            bc bison build-essential flex xz-utils curl \
            libncurses-dev libssl-dev python3 python3-distutils \
            python3-pip python3-venv git unzip ccache libelf-dev libhiredis0.14 clang-16 lld-16

      - name: Set Python environment
        run: |
          python3 -m pip install --upgrade pip

      - name: Setup Clang environment
        run: |
          export CC=clang-16
          export CXX=clang++-16
          echo "Clang path: $(which clang-16)"

      - name: Build Kernel
        working-directory: ${{ github.workspace }}
        run: |
          # Example: build using make, replace with your exact target
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig
          make -j$(nproc) O=out ARCH=arm64 CC=clang

      - name: Package AnyKernel3
        working-directory: ${{ github.workspace }}/AnyKernel3
        run: |
          cp ${{ github.workspace }}/out/arch/arm64/boot/Image.gz-dtb .
          zip -r Nethunter-Kernel-V4.zip ./*
          
      - name: Upload Kernel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nethunter-Kernel-V4
          path: ${{ github.workspace }}/AnyKernel3/Nethunter-Kernel-V4.zip
